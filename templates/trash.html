{% if not is_ajax %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trash - CloudVault</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ range(1, 10000) | random }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta name="csrf-token" content="{{ csrf_token() }}">
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="CloudVault" class="sidebar-logo"
                    style="width: 40px; height: 40px;">
                <span class="sidebar-brand">CloudVault</span>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Storage</div>
                    <a href="/" class="nav-item">
                        <i class="fas fa-folder"></i>
                        <span>My Files</span>
                    </a>
                    <a href="/trash" class="nav-item active">
                        <i class="fas fa-trash-alt"></i>
                        <span>Trash</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <a href="/settings" class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-card" onclick="toggleUserMenu()">
                    <div class="user-avatar">{{ username[0]|upper if username else 'U' }}</div>
                    <div class="user-info">
                        <div class="user-name">{{ username }}</div>
                    </div>
                    <i class="fas fa-chevron-up user-chevron"></i>
                </div>

                <div class="dropdown-menu" id="userMenu" style="bottom: 100%; top: auto; margin-bottom: 8px;">
                    <a href="/settings" class="dropdown-item">
                        <i class="fas fa-cog"></i> Settings
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="/logout" class="dropdown-item danger">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="main-content-area">
            {% endif %}
            <div id="spa-content-container">
                <header class="content-header">
                    <div class="content-title">
                        <button class="btn btn-icon btn-ghost mobile-menu-btn" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h2><i class="fas fa-trash-alt" style="color: var(--danger); margin-right: 12px;"></i> Trash
                        </h2>
                    </div>

                    {% if files %}
                    <button class="btn btn-danger" onclick="emptyTrash()">
                        <i class="fas fa-trash"></i>
                        <span class="hide-mobile">Empty Trash</span>
                    </button>
                    {% endif %}
                </header>

                <div class="content-body" id="spa-content">
                    <div class="alert alert-warning mb-6">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Files in trash will be permanently deleted after 30 days</span>
                    </div>

                    {% if files %}
                    <div class="file-grid" id="fileGrid">
                        {% for file in files %}
                        <div class="file-card animate-scale-up" id="file-{{ file.id }}">
                            <div class="file-preview">
                                <i class="file-icon fas fa-file"></i>
                            </div>
                            <div class="file-name" title="{{ file.filename }}">{{ file.filename }}</div>
                            <div class="file-meta">
                                Deleted {{ file.deleted_at[:10] if file.deleted_at else 'recently' }}
                            </div>
                            <div class="flex gap-2 mt-4" style="position: relative; z-index: 10;">
                                <button class="btn btn-secondary btn-sm" style="flex: 1;"
                                    onclick="restoreFile('{{ file.id }}')">
                                    <i class="fas fa-undo"></i> Restore
                                </button>
                                <button class="btn btn-icon btn-sm btn-ghost" style="color: var(--danger);"
                                    onclick="permanentDelete('{{ file.id }}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-trash-alt"></i>
                        </div>
                        <h3 class="empty-state-title">Trash is Empty</h3>
                        <p class="empty-state-text">Files you delete will appear here for 30 days</p>
                        <a href="/" class="btn btn-primary" style="text-decoration: none;">
                            <i class="fas fa-arrow-left"></i> Back to Files
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div> <!-- End spa-content-container -->
            {% if not is_ajax %}
        </main>
    </div>

    <!-- Navigation Loading Bar -->
    <div id="navLoadingBar" class="nav-loading-bar"></div>

    <script src="{{ url_for('static', filename='modal.js') }}?v=5"></script>
    <script>
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-card')) {
                const userMenu = document.getElementById('userMenu');
                if (userMenu) userMenu.style.display = 'none';
            }
        });

        // Global SPA Navigation logic (same as dashboard.html)
        async function navigateSPA(url, pushState = true) {
            const navBar = document.getElementById('navLoadingBar');
            const mainContent = document.getElementById('main-content-area');

            navBar.style.width = '30%';

            try {
                const response = await fetch(url + (url.includes('?') ? '&' : '?') + 'ajax=true', {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                if (!response.ok) throw new Error('Navigation failed');
                navBar.style.width = '70%';
                const htmlText = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlText, 'text/html');
                const newContent = doc.getElementById('spa-content-container');

                if (!newContent) {
                    window.location.href = url;
                    return;
                }

                const oldBody = mainContent.querySelector('.content-body');
                if (oldBody) oldBody.classList.add('fade-out');

                setTimeout(() => {
                    const currentContainer = document.getElementById('spa-content-container');
                    if (currentContainer) currentContainer.innerHTML = newContent.innerHTML;

                    const newBody = document.querySelector('#spa-content-container .content-body');
                    if (newBody) newBody.classList.add('fade-in');

                    if (pushState) window.history.pushState({ url }, '', url);

                    // Update Title
                    const newTitle = doc.querySelector('title');
                    if (newTitle) document.title = newTitle.textContent;

                    navBar.style.width = '100%';
                    setTimeout(() => { navBar.style.width = '0'; }, 300);
                }, 250);
            } catch (error) {
                window.location.href = url;
            }
        }

        // Global Link Interceptor
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link) {
                const url = link.getAttribute('href');
                if (url && !url.startsWith('http') && !url.startsWith('#') && !url.includes('logout')) {
                    if (e.ctrlKey || e.shiftKey || e.metaKey || link.target === '_blank') return;
                    e.preventDefault();
                    navigateSPA(url);
                    document.getElementById('sidebar').classList.remove('open');
                }
            }
        });

        async function restoreFile(fileId) {
            try {
                const response = await fetch(`/restore/${fileId}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                });
                if (response.ok) {
                    const card = document.getElementById(`file-${fileId}`);
                    if (card) card.remove();
                    if (!document.querySelector('.file-card')) navigateSPA('/trash', false);
                    await Modal.alert('Success', 'File restored successfully');
                } else {
                    const data = await response.json();
                    await Modal.alert('Error', data.error || 'Failed to restore file');
                }
            } catch (e) {
                console.error('Restore error:', e);
            }
        }

        async function permanentDelete(fileId) {
            const confirmed = await Modal.confirm('Permanently Delete?', 'This action cannot be undone. Are you sure?', 'Delete', 'Cancel', true);
            if (!confirmed) return;

            try {
                const response = await fetch(`/delete/permanent/${fileId}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                });
                if (response.ok) {
                    const card = document.getElementById(`file-${fileId}`);
                    if (card) card.remove();
                    if (!document.querySelector('.file-card')) navigateSPA('/trash', false);
                } else {
                    const data = await response.json();
                    await Modal.alert('Error', data.error || 'Failed to delete file');
                }
            } catch (e) {
                console.error('Delete error:', e);
            }
        }

        async function emptyTrash() {
            const confirmed = await Modal.confirm('Empty Trash?', 'Permanently delete ALL files? This cannot be undone.', 'Empty Trash', 'Cancel', true);
            if (!confirmed) return;

            try {
                const response = await fetch('/trash/empty', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                });
                if (response.ok) navigateSPA('/trash', false);
                else await Modal.alert('Error', 'Failed to empty trash');
            } catch (e) {
                await Modal.alert('Error', 'An error occurred');
            }
        }
    </script>
    {% endif %}
</body>

</html>